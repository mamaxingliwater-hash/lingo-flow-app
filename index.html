<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LingoFlow - 最终版</title>
    <!-- 最终解决方案：所有样式内联，不依赖任何外部 CDN -->
    <style>
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }

        /* 基础样式 (替代 Tailwind) */
        body { margin: 0; padding: 0; background-color: #f3f4f6; font-family: sans-serif; color: #1f2937; }
        #app { max-width: 448px; margin-left: auto; margin-right: auto; background-color: #ffffff; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); overflow: hidden; min-height: 100vh; padding-bottom: 5rem; }
        
        /* 头部样式 */
        .header { background-color: #4f46e5; color: #ffffff; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.25rem; font-weight: 700; }
        .header button { padding: 0.25rem; border-radius: 9999px; }

        /* 浮动按钮样式 */
        #add-btn { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%); width: 4rem; height: 4rem; background-color: #4f46e5; color: #ffffff; border-radius: 9999px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; z-index: 20; border: none; }
        #add-btn:hover { background-color: #4338ca; }
        
        /* 其他辅助样式 */
        .p-4 { padding: 1rem; }
        .text-center { text-align: center; }
        .py-20 { padding-top: 5rem; padding-bottom: 5rem; }
        .text-gray-400 { color: #9ca3af; }
        .bg-gray-200 { background-color: #e5e7eb; }
        .w-16 { width: 4rem; }
        .h-16 { height: 4rem; }
        .rounded-full { border-radius: 9999px; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .mb-4 { margin-bottom: 1rem; }
        .text-sm { font-size: 0.875rem; }
        .mt-2 { margin-top: 0.5rem; }
        .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; margin-bottom: 0; }
        .bg-white { background-color: #ffffff; }
        .p-6 { padding: 1.5rem; }
        .rounded-2xl { border-radius: 1rem; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .border-gray-100 { border-color: #f3f4f6; border-width: 1px; }
        .h-32 { height: 8rem; }
        .w-full { width: 100%; }
        .text-xl { font-size: 1.25rem; }
        .font-medium { font-weight: 500; }
        .placeholder-gray-300::placeholder { color: #d1d5db; }
        .border { border-width: 1px; }
        .rounded-lg { border-radius: 0.5rem; }
        .resize-none { resize: none; }
        .p-3 { padding: 0.75rem; }
        .my-4 { margin-top: 1rem; margin-bottom: 1rem; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .space-x-2 > :not([hidden]) ~ :not([hidden]) { margin-left: 0.5rem; margin-right: 0; }
        .text-gray-500 { color: #6b7280; }
        .uppercase { text-transform: uppercase; }
        .tracking-wider { letter-spacing: 0.05em; }
        .outline-none:focus { outline: 0; }
        .bg-transparent { background-color: transparent; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .text-white { color: #ffffff; }
        .font-semibold { font-weight: 600; }
        .bg-indigo-600 { background-color: #4f46e5; }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .hover\:bg-indigo-700:hover { background-color: #4338ca; }
        .rounded-xl { border-radius: 0.75rem; }
        
        /* Card specifics */
        .object-cover { object-fit: cover; }
        .opacity-90 { opacity: 0.9; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .bottom-2 { bottom: 0.5rem; }
        .left-2 { left: 0.5rem; }
        .right-2 { right: 0.5rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-bold { font-weight: 700; }
        .text-gray-800 { color: #1f2937; }
        .text-gray-600 { color: #4b5563; }
        .italic { font-style: italic; }
        .text-xs { font-size: 0.75rem; }
        .text-indigo-900 { color: #3730a3; }
        .leading-relaxed { line-height: 1.625; }
        .hover\:text-red-400:hover { color: #f87171; }
        .active\:scale-95:active { transform: scale(0.95); }
        .safe-top { padding-top: constant(safe-area-inset-top); padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: constant(safe-area-inset-bottom); padding-bottom: env(safe-area-inset-bottom); }
        
        /* Language Badges (Manual color setup) */
        .bg-blue-100 { background-color: #eff6ff; } .text-blue-800 { color: #1e40af; }
        .bg-red-100 { background-color: #fee2e2; } .text-red-800 { color: #991b1b; }
        .bg-pink-100 { background-color: #fce7f3; } .text-pink-800 { color: #9d174d; }
        .bg-indigo-100 { background-color: #eef2ff; } .text-indigo-800 { color: #3730a3; }
        .bg-yellow-100 { background-color: #fef3c7; } .text-yellow-800 { color: #a16207; }
        .bg-orange-100 { background-color: #fff7ed; } .text-orange-800 { color: #9a3412; }
        .bg-emerald-100 { background-color: #ecfdf5; } .text-emerald-800 { color: #065f46; }

    </style>
</head>
<body class="bg-gray-100 p-4 font-sans text-gray-800">

    <div id="app" class="max-w-md mx-auto bg-white rounded-xl shadow-2xl overflow-hidden min-h-screen pb-20">
        
        <!-- Header -->
        <header class="header safe-top">
            <h1 class="text-xl font-bold">LingoFlow (最终版)</h1>
            <button id="settings-btn" class="p-1 rounded-full hover:bg-indigo-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2zM4 12.22v-.44a2 2 0 0 1 2-2h.44a2 2 0 0 1 2 2v.44a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zM18 12.22v-.44a2 2 0 0 1 2-2h.44a2 2 0 0 1 2 2v.44a2 2 0 0 1-2 2h-.44a2 2 0 0 1-2-2zM12.22 20v-.44a2 2 0 0 0-2-2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2zM12 10a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/></svg>
            </button>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="p-4"></main>

        <!-- Floating Action Button -->
        <button id="add-btn" class="fixed bottom-6 right-1/2 translate-x-1/2 w-16 h-16 bg-indigo-600 text-white rounded-full shadow-xl flex items-center justify-center hover:bg-indigo-700 active:scale-95 safe-bottom" style="transform: translateX(-50%);">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
        </button>
    </div>

    <script>
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const mainContent = document.getElementById('main-content');
        let currentView = 'list';

        // --- Data & State (Local Storage) ---
        let vocab = JSON.parse(localStorage.getItem('lingo_vocab') || '[]');
        let apiKey = localStorage.getItem('gemini_api_key') || '';

        // --- Utility Functions ---
        function saveVocab() { localStorage.setItem('lingo_vocab', JSON.stringify(vocab)); }
        function saveApiKey(key) { apiKey = key; localStorage.setItem('gemini_api_key', key); }

        function showLoading(text = '智能分析中...') {
            mainContent.innerHTML = `
                <div class="flex flex-col items-center justify-center h-48 text-indigo-600 space-y-3" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:12rem; color:#4f46e5; margin-top:0.75rem; margin-bottom:0.75rem;">
                    <svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.1 2.2"/></svg>
                    <p class="font-medium">${text}</p>
                </div>
            `;
        }

        function createLanguageBadge(lang) {
            const colors = { 'English': 'bg-blue-100 text-blue-800', 'Chinese': 'bg-red-100 text-red-800', 'Japanese': 'bg-pink-100 text-pink-800', 'French': 'bg-indigo-100 text-indigo-800', 'Spanish': 'bg-yellow-100 text-yellow-800', 'German': 'bg-orange-100 text-orange-800', 'Arabic': 'bg-emerald-100 text-emerald-800' };
            const className = `text-xs px-2 py-0.5 rounded-full font-medium ${colors[lang] || 'bg-gray-100 text-gray-800'}`;
            return `<span class="${className}">${lang}</span>`;
        }
        
        // --- View Logic ---

        function renderList() {
            currentView = 'list';
            document.getElementById('add-btn').style.display = 'flex'; // Show FAB

            if (vocab.length === 0) {
                mainContent.innerHTML = `
                    <div class="text-center py-20 text-gray-400">
                        <div class="bg-gray-200 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style="display:flex; align-items:center; justify-content:center; margin-left:auto; margin-right:auto;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v.01"/><path d="M12 22v.01"/><path d="M2 12h.01"/><path d="M22 12h.01"/><path d="M19.07 4.93l-.01.01"/><path d="M4.93 19.07l.01-.01"/><path d="M19.07 19.07l-.01.01"/><path d="M4.93 4.93l.01-.01"/></svg>
                        </div>
                        <p>生词本中还没有单词。</p>
                        <p class="text-sm mt-2">点击 "+" 添加你的第一个单词。</p>
                    </div>
                `;
                return;
            }

            // Render word cards
            mainContent.innerHTML = vocab.map((word, index) => `
                <div class="bg-white rounded-2xl shadow-md border border-gray-100 overflow-hidden mb-4">
                    <div class="relative h-32 bg-gray-100" style="position:relative; height:8rem; background-color:#f3f4f6;">
                        <img src="${word.imageUrl}" alt="${word.word}" class="w-full h-full object-cover opacity-90" style="width:100%; height:100%; object-fit:cover; opacity:0.9;" onerror="this.src='https://placehold.co/600x400/eee/999?text=${encodeURIComponent(word.word)}';">
                        <div class="absolute bottom-2 left-2" style="position:absolute; bottom:0.5rem; left:0.5rem;">${createLanguageBadge(word.language)}</div>
                    </div>
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2" style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <h3 class="text-2xl font-bold text-gray-800">${word.word}</h3>
                            <button onclick="deleteWord(${index})" class="text-gray-300 hover:text-red-400" style="color:#d1d5db;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M13 3a1 1 0 0 0-1-1H12a1 1 0 0 0-1 1v3h-2"/></svg>
                            </button>
                        </div>
                        <p class="text-gray-600 font-medium mb-1">${word.definition}</p>
                        <p class="text-gray-400 text-sm mb-3 italic">${word.definition_en}</p>
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100" style="background-color:#f9fafb; padding:0.75rem; border-radius:0.75rem;">
                            <p class="text-indigo-900 text-sm leading-relaxed" style="color:#3730a3;">"${word.example}"</p>
                            <p class="text-gray-400 text-xs mt-1">${word.translation}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderAddWord() {
            currentView = 'add';
            document.getElementById('add-btn').style.display = 'none'; // Hide FAB
            mainContent.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
                        <label class="block text-sm font-medium text-gray-500 mb-2 uppercase tracking-wider">新词条</label>
                        <textarea id="input-text" placeholder="粘贴单词或句子..." class="w-full h-32 text-xl font-medium placeholder:text-gray-300 border focus:ring-2 focus:ring-indigo-500 rounded-lg resize-none p-3" style="width:100%; height:8rem; font-size:1.25rem; border-color:#d1d5db; border-width:1px;"></textarea>
                        <div class="h-px bg-gray-100 my-4" style="height:1px;"></div>
                        <div class="flex items-center justify-between" style="display:flex; align-items:center; justify-content:space-between;">
                            <div class="flex items-center space-x-2 text-gray-500" style="display:flex; align-items:center;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 8h.01"/><path d="M15 8h.01"/><path d="M17 17h.01"/><path d="M10 12h.01"/><path d="M2 7a5 5 0 0 1 5-5h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7z"/></svg>
                                <select id="target-lang" class="bg-transparent font-medium outline-none text-sm">
                                    ${['English', 'Chinese', 'Japanese', 'French', 'Spanish', 'German', 'Arabic'].map(l => `<option value="${l}">${l}</option>`).join('')}
                                </select>
                            </div>
                            <button id="analyze-btn" class="px-6 py-2 rounded-full font-semibold text-white bg-indigo-600 shadow-md hover:bg-indigo-700">智能分析</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('analyze-btn').onclick = processNewWord;
        }

        function renderSettings() {
            currentView = 'settings';
            document.getElementById('add-btn').style.display = 'none'; // Hide FAB
            mainContent.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h2 class="text-xl font-bold mb-4">AI 配置 (Gemini)</h2>
                        <p class="text-sm text-gray-500 mb-4">
                            输入您的 Gemini API Key，开启智能释义和故事生成。
                        </p>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Key</label>
                        <input id="api-key-input" type="password" value="${apiKey}" placeholder="AIzaSy..." class="w-full p-3 border rounded-xl bg-gray-50 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <div class="mt-4 p-3 bg-blue-50 text-blue-700 text-xs rounded-lg">
                            注意：此版本无云同步功能，数据保存在您的浏览器中。
                        </div>
                    </div>
                    <button id="close-settings-btn" class="w-full py-3 bg-gray-200 text-gray-700 font-semibold rounded-xl">返回</button>
                </div>
            `;
            document.getElementById('close-settings-btn').onclick = () => renderList();
            document.getElementById('api-key-input').onchange = (e) => saveApiKey(e.target.value);
        }

        // --- Action Functions ---

        async function callAI(prompt) {
            if (!apiKey) {
                await new Promise(r => setTimeout(r, 1500));
                return JSON.stringify({ definition: "模拟释义：请在设置中输入 Key", definition_en: "Simulated response. Please enter API Key.", example: "This is a simulated example.", translation: "这是一个模拟例句。", tags: ["simulated"] });
            }
            try {
                // 仅调用 Gemini API，这是唯一的外部依赖
                const response = await fetch(API_URL + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                const cleanJson = text.replace(/```json/g, '').replace(/```/g, '').trim();
                return cleanJson;
            } catch (error) {
                console.error("AI Error:", error);
                alert("AI 连接失败，请检查网络或 Key。");
                return null;
            }
        }

        async function processNewWord() {
            const inputText = document.getElementById('input-text').value.trim();
            const targetLang = document.getElementById('target-lang').value;
            if (!inputText) return;
            
            showLoading();

            const prompt = `
                You are a linguistics expert. Analyze the word/phrase: "${inputText}".
                Target Language context: ${targetLang}.
                Return a purely JSON object with this structure:
                {
                    "word": "${inputText}",
                    "definition": "Meaning in native language (if word is JP, give JP meaning, else CN)",
                    "definition_en": "Meaning in English",
                    "example": "A sentence in the target language using the word",
                    "translation": "Translation of the example sentence in Chinese",
                    "tags": ["noun/verb/adj", "topic"]
                }
            `;

            const result = await callAI(prompt);
            let aiData;
            try {
                aiData = JSON.parse(result);
            } catch (e) {
                console.error("JSON parsing failed", e);
                aiData = { word: inputText, definition: "AI 解析失败", definition_en: "Failed to parse AI response.", example: "N/A", translation: "N/A", tags: ["manual"] };
            }

            vocab.unshift({
                ...aiData,
                language: targetLang,
                imageUrl: `https://placehold.co/600x400/indigo/white?text=${encodeURIComponent(aiData.word)}`, 
            });
            saveVocab();
            renderList();
        }

        function deleteWord(index) {
            if (confirm('确认删除此生词卡片吗？')) {
                vocab.splice(index, 1);
                saveVocab();
                renderList();
            }
        }

        // --- Event Listeners ---
        document.getElementById('add-btn').onclick = () => renderAddWord();
        document.getElementById('settings-btn').onclick = () => renderSettings();

        // --- Initialization ---
        renderList();

    </script>
</body>
</html>
