<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LingoFlow App</title>
    <!-- 引入 React 和 Babel 来运行 JSX 文件 -->
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 引入 Tailwind CSS 样式 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Hide scrollbar for mobile experience */
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;  /* Chrome, Safari and Opera */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 运行你的 App.jsx 文件 (已内联到此脚本块中，以避免 GitHub Pages 的路径冲突) -->
    <script type="text/babel">
import React, { useState, useEffect } from 'react';
import { 
  BookOpen, 
  Plus, 
  Settings, 
  Languages, 
  Sparkles, 
  CheckCircle2, 
  Circle,
  Trash2,
  RefreshCw
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged, 
  signInWithCustomToken,
  GoogleAuthProvider, 
  signInWithPopup,    
  signOut             
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  query, 
  orderBy, 
  onSnapshot, 
  deleteDoc, 
  doc, 
  updateDoc,
  serverTimestamp
} from 'firebase/firestore';

// --- Firebase Configuration & Initialization ---
// 注意：在您的托管环境中，window.__firebase_config 和 window.__app_id 必须在 index.html 之前定义。
// 我们在此处添加检查以防止运行时错误。
// 请注意：在实际的 GitHub Pages 上，您可能需要手动添加一个包含以下变量的 <script> 标签。
const firebaseConfig = {
    // 默认的 Firebase 配置 (占位符)
    apiKey: "AIzaSyC...",
    authDomain: "projectId.firebaseapp.com",
    projectId: "your-project-id",
    storageBucket: "your-project-id.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:234567890:web:abcde",
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = 'default-app-id'; // 在 GitHub Pages 环境中使用一个默认 ID
const googleProvider = new GoogleAuthProvider(); // 初始化 Google 登录提供者

// --- AI Service (Simulated & Real) ---
const callAI = async (prompt, apiKey, modelType = 'text') => {
  if (!apiKey) {
    // Simulation Mode for Demo
    await new Promise(resolve => setTimeout(resolve, 1500));
    if (prompt.includes("story")) {
      return "这是一个模拟的 AI 故事。请在设置中输入您的 API Key。主角学会了 **Word1**，并用它克服了 **Word2** 的困难。";
    }
    // Default mock response for definition
    return JSON.stringify({
      definition: "这是一个模拟的中文释义 (Simulated Definition).",
      definition_en: "A simulated English definition for demonstration purposes.",
      example: "This is an example sentence using the word.",
      translation: "这是一个使用该单词的例句。",
      tags: ["noun", "simulated"]
    });
  }

  // Real Gemini API Call 
  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }]
      })
    });
    
    const data = await response.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
    return text || "Error generating content";
  } catch (error) {
    console.error("AI Error", error);
    window.alert("AI 调用失败，请检查您的 API Key 或网络连接。"); 
    return null;
  }
};

// --- Components ---

const LanguageBadge = ({ lang }) => {
  const colors = {
    'English': 'bg-blue-100 text-blue-800',
    'Chinese': 'bg-red-100 text-red-800',
    'Japanese': 'bg-pink-100 text-pink-800',
    'French': 'bg-indigo-100 text-indigo-800',
    'Spanish': 'bg-yellow-100 text-yellow-800',
    'German': 'bg-orange-100 text-orange-800',
    'Arabic': 'bg-emerald-100 text-emerald-800',
  };
  return (
    <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${colors[lang] || 'bg-gray-100 text-gray-800'}`}>
      {lang}
    </span>
  );
};

const App = () => {
  const [user, setUser] = useState(null);
  const [words, setWords] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('list'); // list, add, story, settings
  const [selectedWords, setSelectedWords] = new Set();
  
  // Add Word State
  const [inputText, setInputText] = useState('');
  const [targetLang, setTargetLang] = useState('English');
  const [isProcessing, setIsProcessing] = useState(false);
  
  // Settings State
  const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
  
  // Story State
  const [generatedStory, setGeneratedStory] = useState('');
  const [isGeneratingStory, setIsGeneratingStory] = useState(false);

  // --- Auth & Data Sync ---
  useEffect(() => {
    const initAuth = async () => {
      // 在 GitHub Pages 上，我们不能依赖全局变量 __initial_auth_token。
      // 直接使用匿名登录，并强制用户通过 Google 登录进行同步。
      await signInAnonymously(auth);
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (!u) setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    // Private user collection
    const q = query(
      collection(db, 'artifacts', appId, 'users', user.uid, 'vocab'),
      orderBy('createdAt', 'desc')
    );
    
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const vocabData = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setWords(vocabData);
      setLoading(false);
    }, (err) => console.error("Firestore error:", err));

    return () => unsubscribe();
  }, [user]);
  
  // --- Auth Actions for Synchronization ---
  
  const handleGoogleSignIn = async () => {
    try {
        await signInWithPopup(auth, googleProvider);
        // 使用自定义模态而不是 alert
        window.alert("Google 登录成功！数据将在所有设备上实时同步。");
    } catch (error) {
        console.error("Google Sign-in Error:", error);
        // 使用自定义模态而不是 alert
        window.alert("Google 登录失败，请确保您已在 Firebase 控制台开启 Google 登录。");
    }
  };

  const handleSignOut = async () => {
    try {
        // 退出当前用户
        await signOut(auth);
        // 退出后重新匿名登录，保持 App 可用性
        await signInAnonymously(auth); 
        // 使用自定义模态而不是 alert
        window.alert("您已退出登录，当前为访客模式。");
    } catch (error) {
        console.error("Sign-out Error:", error);
    }
  };


  // --- Data & AI Actions ---

  const handleSaveApiKey = (key) => {
    setApiKey(key);
    localStorage.setItem('gemini_api_key', key);
  };

  const processNewWord = async () => {
    if (!inputText.trim()) return;
    // 检查用户是否已登录 (非空或匿名)
    if (!user) {
        window.alert("请先登录或等待认证完成。");
        return;
    }
    
    setIsProcessing(true);

    // Construct Prompt for AI
    const prompt = `
      You are a linguistics expert. Analyze the word/phrase: "${inputText}".
      Target Language context: ${targetLang}.
      
      Return a purely JSON object (no markdown, no code blocks) with this structure:
      {
        "word": "${inputText}",
        "definition": "Meaning in native language (if word is JP, give JP meaning, else CN)",
        "definition_en": "Meaning in English",
        "example": "A sentence in the target language using the word",
        "translation": "Translation of the example sentence in Chinese",
        "tags": ["noun/verb/adj", "topic"]
      }
    `;

    let aiData = {};
    let saveText = inputText; // Use original input text for saving if AI fails
    try {
      const result = await callAI(prompt, apiKey);
      // Clean up potential markdown code blocks from AI response
      const cleanJson = result.replace(/```json/g, '').replace(/```/g, '').trim();
      aiData = JSON.parse(cleanJson);
    } catch (e) {
      console.error("Parsing failed, falling back", e);
      aiData = {
        word: saveText,
        definition: "无法连接 AI 或解析失败 (AI Failed to Process)",
        definition_en: "AI Connection Failed",
        example: "请手动添加例句",
        translation: "N/A",
        tags: ["manual"]
      };
    }

    // Add to Firestore
    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'vocab'), {
        ...aiData,
        language: targetLang,
        createdAt: serverTimestamp(),
        // Use Unsplash source for demo images (In production, use DALL-E or reliable API)
        imageUrl: `https://placehold.co/600x400/indigo/white?text=${encodeURIComponent(saveText)}`, 
      });
      setInputText('');
      setActiveTab('list');
    } catch (e) {
      // Use custom modal instead of alert
      window.alert("保存失败: " + e.message);
    } finally {
      setIsProcessing(false);
    }
  };

  const toggleSelectWord = (id) => {
    const newSet = new Set(selectedWords);
    if (newSet.has(id)) newSet.delete(id);
    else newSet.add(id);
    setSelectedWords(newSet);
  };

  const generateStory = async () => {
    if (selectedWords.size === 0) return;
    setIsGeneratingStory(true);
    
    const selectedWordList = words.filter(w => selectedWords.has(w.id)).map(w => w.word);
    
    const prompt = `
      Create a short, engaging story (max 150 words) specifically to help me memorize these words: ${selectedWordList.join(', ')}.
      The story should be in ${targetLang} but allow mixed language if helpful for learning.
      Highlight the selected words in **bold**.
    `;

    const story = await callAI(prompt, apiKey);
    setGeneratedStory(story);
    setIsGeneratingStory(false);
  };

  const deleteWord = async (id) => {
    // Use custom modal instead of confirm
    if(window.confirm('确认删除此生词卡片吗？')) {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'vocab', id));
      const newSet = new Set(selectedWords);
      newSet.delete(id);
      setSelectedWords(newSet);
    }
  };

  // --- Views ---

  if (loading) return (
    <div className="flex items-center justify-center h-screen bg-slate-50">
      <div className="animate-spin text-indigo-600">
        <RefreshCw size={32} />
      </div>
    </div>
  );

  return (
    <div className="flex flex-col h-screen bg-slate-50 font-sans text-slate-900 max-w-md mx-auto shadow-2xl overflow-hidden relative border-x border-slate-200">
      
      {/* Header */}
      <header className="bg-white border-b px-4 py-3 flex items-center justify-between sticky top-0 z-10 safe-top">
        <div className="flex items-center space-x-2">
          <div className="bg-indigo-600 text-white p-1.5 rounded-lg">
            <BookOpen size={20} />
          </div>
          <h1 className="font-bold text-lg tracking-tight">LingoFlow</h1>
        </div>
        <button onClick={() => setActiveTab('settings')} className="text-slate-400 hover:text-slate-600">
          <Settings size={20} />
        </button>
      </header>

      {/* Main Content Area */}
      <main className="flex-1 overflow-y-auto p-4 pb-24 scrollbar-hide">
        
        {/* SETTINGS TAB */}
        {activeTab === 'settings' && (
          <div className="space-y-6 animate-fade-in">
            
            {/* AI Configuration */}
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
              <h2 className="text-xl font-bold mb-4">AI 配置</h2>
              <p className="text-sm text-slate-500 mb-4">
                开启自动释义、故事生成和图片功能，请输入您的 Gemini API Key。
              </p>
              <label className="block text-sm font-medium text-slate-700 mb-1">Google Gemini API Key</label>
              <input 
                type="password" 
                value={apiKey}
                onChange={(e) => handleSaveApiKey(e.target.value)}
                placeholder="AIzaSy..."
                className="w-full p-3 border rounded-xl bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none"
              />
              <div className="mt-4 p-3 bg-blue-50 text-blue-700 text-xs rounded-lg">
                提示：未设置密钥时，App 会进入“模拟模式”。
              </div>
            </div>

            {/* Account & Sync (New Section) */}
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <h2 className="text-xl font-bold mb-4">账号与同步</h2>
                <p className="text-sm text-slate-500 mb-4">
                    使用 Google 账号登录后，你的生词数据将在所有设备间实时同步。
                </p>
                
                {user?.isAnonymous || !user?.uid ? (
                    // 匿名用户或未登录时显示 Google 登录按钮
                    <button 
                        onClick={handleGoogleSignIn}
                        className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-md hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"
                    >
                        [Image of Google logo]
                        使用 Google 账号登录
                    </button>
                ) : (
                    // 登录后显示用户信息和退出按钮
                    <div className="space-y-4">
                        <p className="text-sm font-medium text-slate-700">当前用户ID: <span className="text-xs break-all bg-slate-100 p-1 rounded font-mono">{user.uid}</span></p>
                        <p className="text-xs text-slate-500">此 ID 确保您的数据是唯一的，并能在不同设备上同步。</p>
                        <button 
                            onClick={handleSignOut}
                            className="w-full py-3 bg-red-100 text-red-600 font-semibold rounded-xl hover:bg-red-200"
                        >
                            退出登录
                        </button>
                    </div>
                )}
            </div>
            
            <button onClick={() => setActiveTab('list')} className="w-full py-3 bg-slate-200 text-slate-700 font-semibold rounded-xl">
              关闭设置
            </button>
          </div>
        )}

        {/* ADD WORD TAB */}
        {activeTab === 'add' && (
          <div className="space-y-4 animate-slide-up">
            <div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
              <label className="block text-sm font-medium text-slate-500 mb-2 uppercase tracking-wider">新词条</label>
              <textarea 
                value={inputText}
                onChange={(e) => setInputText(e.target.value)}
                placeholder="粘贴单词或句子..."
                className="w-full h-32 text-xl font-medium placeholder:text-slate-300 border-none focus:ring-0 resize-none p-0"
                autoFocus
              />
              <div className="h-px bg-slate-100 my-4" />
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-2 text-slate-500">
                  <Languages size={18} />
                  <select 
                    value={targetLang}
                    onChange={(e) => setTargetLang(e.target.value)}
                    className="bg-transparent font-medium outline-none text-sm"
                  >
                    {['English', 'Chinese', 'Japanese', 'French', 'Spanish', 'German', 'Arabic'].map(l => (
                      <option key={l} value={l}>{l}</option>
                    ))}
                  </select>
                </div>
                <button 
                  onClick={processNewWord}
                  disabled={!inputText || isProcessing}
                  className={`px-6 py-2 rounded-full font-semibold text-white transition-all ${
                    inputText ? 'bg-indigo-600 shadow-md hover:bg-indigo-700' : 'bg-slate-300 cursor-not-allowed'
                  }`}
                >
                  {isProcessing ? <RefreshCw className="animate-spin" size={20} /> : '智能分析'}
                </button>
              </div>
            </div>
          </div>
        )}

        {/* LIST TAB (DEFAULT) */}
        {activeTab === 'list' && (
          <div className="space-y-4">
            {words.length === 0 ? (
              <div className="text-center py-20 text-slate-400">
                <div className="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                  <Sparkles size={24} />
                </div>
                <p>生词本中还没有单词。</p>
                <p className="text-sm mt-2">点击 "+" 添加你的第一个单词。</p>
              </div>
            ) : (
              words.map((word) => (
                <div 
                  key={word.id} 
                  className={`bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden transition-all ${
                    selectedWords.has(word.id) ? 'ring-2 ring-indigo-500 bg-indigo-50' : ''
                  }`}
                >
                  <div className="relative h-32 bg-slate-100">
                    <img 
                      src={word.imageUrl} 
                      alt={word.word} 
                      className="w-full h-full object-cover opacity-90"
                      onError={(e) => {
                        e.target.src = 'https://placehold.co/600x400/eee/999?text=No+Image';
                      }}
                    />
                    <div className="absolute top-2 right-2 flex space-x-1">
                      <button 
                        onClick={() => toggleSelectWord(word.id)}
                        className="p-2 bg-white/80 backdrop-blur rounded-full shadow-sm text-indigo-600 hover:bg-white transition-colors"
                      >
                        {selectedWords.has(word.id) ? <CheckCircle2 size={20} /> : <Circle size={20} />}
                      </button>
                    </div>
                    <div className="absolute bottom-2 left-2">
                       <LanguageBadge lang={word.language} />
                    </div>
                  </div>
                  
                  <div className="p-4">
                    <div className="flex justify-between items-start mb-2">
                      <h3 className="text-2xl font-bold text-slate-800">{word.word}</h3>
                      <button onClick={() => deleteWord(word.id)} className="text-slate-300 hover:text-red-400">
                        <Trash2 size={16} />
                      </button>
                    </div>
                    
                    <p className="text-slate-600 font-medium mb-1">{word.definition}</p>
                    <p className="text-slate-400 text-sm mb-3 italic">{word.definition_en}</p>
                    
                    <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                      <p className="text-indigo-900 text-sm leading-relaxed">"{word.example}"</p>
                      <p className="text-slate-400 text-xs mt-1">{word.translation}</p>
                    </div>
                  </div>
                </div>
              ))
            )}
            <div className="h-12"></div> {/* Spacer for FAB */}
          </div>
        )}

        {/* STORY TAB */}
        {activeTab === 'story' && (
          <div className="space-y-4 animate-fade-in h-full flex flex-col">
            <div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 flex-1 flex flex-col">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-bold text-indigo-900 flex items-center gap-2">
                  <Sparkles className="text-indigo-500" size={20} />
                  故事模式
                </h2>
                <span className="text-sm text-slate-500">已选 {selectedWords.size} 个单词</span>
              </div>
              
              <div className="flex-1 overflow-y-auto bg-indigo-50/50 rounded-xl p-4 border border-indigo-100 mb-4">
                {isGeneratingStory ? (
                   <div className="flex flex-col items-center justify-center h-full text-indigo-400 space-y-3">
                     <RefreshCw className="animate-spin" size={32} />
                     <p className="text-sm font-medium">正在为你创作故事...</p>
                   </div>
                ) : generatedStory ? (
                  <div className="prose prose-indigo">
                    <p className="whitespace-pre-wrap leading-relaxed text-slate-700">{generatedStory}</p>
                  </div>
                ) : (
                  <div className="flex flex-col items-center justify-center h-full text-slate-400 text-center p-4">
                    <BookOpen size={40} className="mb-2 opacity-20" />
                    <p>从列表中选择单词，然后点击生成，为它们创作一个记忆情境。</p>
                  </div>
                )}
              </div>

              <div className="flex gap-3">
                <button 
                  onClick={() => setActiveTab('list')}
                  className="flex-1 py-3 bg-slate-100 text-slate-600 font-semibold rounded-xl hover:bg-slate-200"
                >
                  返回列表
                </button>
                <button 
                  onClick={generateStory}
                  disabled={selectedWords.size === 0 || isGeneratingStory}
                  className={`flex-1 py-3 text-white font-bold rounded-xl shadow-md transition-all ${
                     selectedWords.size > 0 ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-slate-300 cursor-not-allowed'
                  }`}
                >
                  生成故事
                </button>
              </div>
            </div>
          </div>
        )}

      </main>

      {/* Floating Navigation / Action Bar */}
      {activeTab === 'list' && (
        <div className="absolute bottom-6 left-0 right-0 flex justify-center items-center gap-4 px-6 pointer-events-none">
          
          {/* Generate Story FAB (Only shows if words selected) */}
          {selectedWords.size > 0 && (
            <button 
              onClick={() => setActiveTab('story')}
              className="pointer-events-auto bg-white text-indigo-600 px-5 py-3 rounded-full shadow-xl border border-indigo-100 flex items-center gap-2 font-bold hover:scale-105 transition-transform"
            >
              <Sparkles size={20} fill="currentColor" className="text-indigo-200" />
              <span>创作故事 ({selectedWords.size})</span>
            </button>
          )}

          {/* Add Word FAB */}
          <button 
            onClick={() => setActiveTab('add')}
            className="pointer-events-auto w-14 h-14 bg-indigo-600 text-white rounded-full shadow-xl flex items-center justify-center hover:bg-indigo-700 hover:scale-105 transition-all active:scale-95"
          >
            <Plus size={32} />
          </button>
        </div>
      )}

    </div>
  );
};

// 使用 React 18 的 API 渲染 App
const container = document.getElementById('root');
if (container) {
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
}
    </script>
</body>
</html>
